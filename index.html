<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Tuy·∫øt Hoa vs Boss Quy ‚Äî Angry Hearts (Mobile FIX v2)</title>
  <style>
    :root{
      --bg1:#0b1024; --bg2:#060912;
      --panel:rgba(255,255,255,.10); --border:rgba(255,255,255,.22);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent; touch-action:none}
    html,body{height:100%;margin:0}
    body{
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 800px at 50% 20%,var(--bg1),var(--bg2));
      color:#fff; overflow:hidden;
    }
    canvas{position:fixed;inset:0;display:block}
    .hud{
      position:fixed; left:calc(env(safe-area-inset-left,0) + 10px);
      top:calc(env(safe-area-inset-top,0) + 10px);
      display:flex; gap:10px; align-items:center; z-index:5;
      background:var(--panel); border:1px solid var(--border);
      backdrop-filter:blur(10px);
      padding:10px 12px; border-radius:16px; font-weight:800;
    }
    .badge{padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:rgba(0,0,0,.15); font-size:14px}
    .btn{padding:10px 14px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.14); color:#fff; font-weight:900}
    .rightHud{
      position:fixed; right:calc(env(safe-area-inset-right,0) + 10px);
      top:calc(env(safe-area-inset-top,0) + 10px); display:flex; gap:10px; z-index:5;
    }
    .fab{min-width:44px; min-height:44px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.14); backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center; font-weight:900}
    .title{
      position:fixed; left:50%; top:calc(env(safe-area-inset-top,0) + 64px);
      transform:translateX(-50%); z-index:3;
      font-size:clamp(18px,5.6vmin,32px); font-weight:900; letter-spacing:.02em;
      -webkit-text-stroke:1px rgba(255,255,255,.6);
      background:linear-gradient(90deg,#ff3d81,#ffb86b,#ffee55,#7dfc8a,#5ad2ff,#a78bfa,#ff3d81);
      background-size:200% 100%; -webkit-background-clip:text; background-clip:text; color:transparent;
      animation:glint 6s linear infinite; text-align:center; pointer-events:none;
      filter:drop-shadow(0 6px 14px rgba(0,0,0,.6));
    }
    @keyframes glint{to{background-position:200% 0}}
    .power{position:fixed; left:calc(env(safe-area-inset-left,0) + 12px); right:calc(env(safe-area-inset-right,0) + 12px); bottom:calc(env(safe-area-inset-bottom,0) + 16px); height:14px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.15); border:1px solid var(--border); z-index:5}
    .powerFill{height:100%; width:0%}
    .powerFill::before{content:""; display:block; height:100%; width:100%; background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444)}
    .center{position:fixed;inset:0;display:grid;place-items:center;z-index:6;pointer-events:none}
    .overlay{pointer-events:auto;background:var(--panel);border:1px solid var(--border);backdrop-filter:blur(10px);padding:22px 24px;border-radius:18px;text-align:center}
    .overlay h1{margin:8px 0 6px;font-size:clamp(22px,7vmin,40px)}
    .overlay p{margin:6px 0 12px;opacity:.9}
    .hidden{display:none}
    .hint{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.35);border:1px solid var(--border);backdrop-filter:blur(6px);padding:10px 14px;border-radius:12px;z-index:6}
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <div class="title">Tuy·∫øt Hoa üíò vs Boss Quy</div>

  <div class="hud">
    <div class="badge">üíò ‚àû</div>
    <div class="badge">‚ù§Ô∏è <span id="bossHp">100</span>%</div>
    <div class="badge">üèÜ <span id="score">0</span></div>
    <button class="btn" id="restart">Ch∆°i l·∫°i</button>
  </div>

  <div class="rightHud">
    <button class="fab" id="fs">‚§¢</button>
    <button class="fab" id="vib">üîî</button>
  </div>

  <div class="power"><div class="powerFill" id="powerFill"></div></div>
  <div class="hint" id="hint">Ch·∫°m 1 l·∫ßn ƒë·ªÉ ƒë·∫∑t n√° & Tuy·∫øt Hoa ‚Ä¢ K√©o ng∆∞·ª£c & th·∫£ ƒë·ªÉ b·∫Øn</div>

  <div class="center hidden" id="win">
    <div class="overlay">
      <h1>üéâ Th·∫Øng r·ªìi!</h1>
      <p>Boss <b>Quy</b> ƒë√£ b·ªã h·∫° üíñ</p>
      <button class="btn" onclick="restart()">Ch∆°i l·∫°i</button>
    </div>
  </div>

  <div class="center hidden" id="lose">
    <div class="overlay">
      <h1>üòø Thua m·∫•t...</h1>
      <p>Ch·∫°m ƒë·ªÉ d·ªùi n√° t·ªõi ng√≥n tay, k√©o ng∆∞·ª£c & th·∫£ ƒë·ªÉ b·∫Øn.</p>
      <button class="btn" onclick="restart()">Ch∆°i l·∫°i</button>
    </div>
  </div>

<script>
const cvs = document.getElementById('c');
const ctx = cvs.getContext('2d');
const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
let W=0, H=0, G=2200;
let firstRun = true;
function resize(){
  W = cvs.width = innerWidth*DPR;
  H = cvs.height = innerHeight*DPR;
  cvs.style.width = innerWidth + 'px';
  cvs.style.height = innerHeight + 'px';
  setDefaultPositions();
  setupBlocks();
}
addEventListener('resize', resize, {passive:true});

const bossHpEl = document.getElementById('bossHp');
const scoreEl  = document.getElementById('score');
const powerFill = document.getElementById('powerFill');
document.getElementById('restart').onclick = () => restart();

const state = { hearts:[], blocks:[], particles:[], score:0, aiming:false, gameover:false, vibrate:false };
const sling = { x: 0, y: 0, r: 56*DPR };
const TH = { x:0, y:0 };
const boss = { x:0, y:0, r: 70*DPR, hp: 100 };

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function setDefaultPositions(){
  // ƒê·∫∑t n√° ·ªü ~28% chi·ªÅu r·ªông, 60% chi·ªÅu cao ‚Äî lu√¥n th·∫•y r√µ tr√™n m·ªçi m√°y
  if (firstRun){ sling.x = Math.max(220*DPR, W*0.28); sling.y = H*0.60; firstRun = false; }
  // Boss ·ªü b√™n ph·∫£i
  boss.x = W - 220*DPR; boss.y = H*0.62;
  // C·∫≠p nh·∫≠t Tuy·∫øt Hoa theo n√°
  TH.x = sling.x - 14*DPR; TH.y = sling.y + 14*DPR;
}

function setupBlocks(){
  state.blocks.length = 0;
  const bx=boss.x-220*DPR, by=boss.y, w=46*DPR, h=130*DPR, gap=18*DPR;
  for(let i=0;i<3;i++) state.blocks.push({x:bx+i*(w+gap), y:by-h/2, w, h, hp:38});
  state.blocks.push({x:bx-10*DPR, y:by-h-24*DPR, w:(w+gap)*3+36*DPR, h:24*DPR, hp:38});
}

const heartPath = new Path2D("M128 224s-64-36.8-96-80C8 88 32 48 64 48c24 0 40 16 64 40 24-24 40-40 64-40 32 0 56 40 32 96-32 43.2-96 80-96 80z");
function heartGrad(hue){const g=ctx.createLinearGradient(-128,0,128,0);const c=[hue%360,(hue+60)%360,(hue+120)%360,(hue+180)%360,(hue+240)%360,(hue+300)%360];c.forEach((h,i)=>g.addColorStop(i/5,`hsl(${h},100%,60%)`));return g;}
function drawHeartAt(x,y,s,ang,hue){
  ctx.save(); ctx.translate(x,y); ctx.rotate(ang); ctx.scale(s,s);
  ctx.fillStyle = heartGrad(hue); ctx.strokeStyle='rgba(255,255,255,.95)'; ctx.lineWidth=6/DPR; ctx.filter='drop-shadow(0 6px 14px rgba(0,0,0,.35))';
  ctx.fill(heartPath); ctx.stroke(heartPath);
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font=`900 ${86}px system-ui`; ctx.lineWidth=13; ctx.strokeStyle='rgba(255,255,255,.95)'; ctx.strokeText('quy',128,128); ctx.fillStyle='rgba(10,10,30,.92)'; ctx.fillText('quy',128,128);
  ctx.restore();
}

// Input
let aimPt=null;
function moveSlingToPointer(e){
  const r=cvs.getBoundingClientRect();
  const x=(e.clientX-r.left)*DPR, y=(e.clientY-r.top)*DPR;
  sling.x = clamp(x, 120*DPR, W*0.62);
  sling.y = clamp(y, H*0.45, H*0.82);
  TH.x = sling.x - 14*DPR; TH.y = sling.y + 14*DPR;
}
function pointerDown(e){
  if(state.gameover) return;
  moveSlingToPointer(e);
  const r=cvs.getBoundingClientRect();
  aimPt={x:(e.clientX-r.left)*DPR,y:(e.clientY-r.top)*DPR};
  state.aiming=true;
  document.getElementById('hint').classList.add('hidden');
}
function pointerMove(e){
  if(!state.aiming) return;
  const r=cvs.getBoundingClientRect();
  aimPt={x:(e.clientX-r.left)*DPR,y:(e.clientY-r.top)*DPR};
}
function pointerUp(e){
  if(!state.aiming) return;
  state.aiming=false;
  const dx=sling.x-aimPt.x, dy=sling.y-aimPt.y;
  const power=Math.min(1.2, Math.hypot(dx,dy)/(180*DPR));
  const angle=Math.atan2(dy,dx);
  const v=1700*power;
  spawnHeart(sling.x, sling.y, Math.cos(angle)*v, Math.sin(angle)*v);
  aimPt=null; setPower(0);
  if(state.vibrate && navigator.vibrate) navigator.vibrate(10);
}
cvs.addEventListener('pointerdown', pointerDown);
cvs.addEventListener('pointermove', pointerMove);
addEventListener('pointerup', pointerUp);
addEventListener('pointercancel', pointerUp);

function setPower(pct){ powerFill.style.width = (pct*100).toFixed(1)+'%'; }

function spawnHeart(x,y,vx,vy){ const hue=(Math.random()*360)|0; state.hearts.push({x,y,vx,vy,ang:0,spin:(Math.random()*2-1)*2,hue,scale:0.5*DPR,life:4,bounces:0});}
function spawnBurst(x,y,hue,n=26){ for(let i=0;i<n;i++){ const a=Math.random()*Math.PI*2, sp=80+Math.random()*260; state.particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:0.9,h:hue}); }}

function update(dt){
  if(state.aiming && aimPt){ const dx=sling.x-aimPt.x, dy=sling.y-aimPt.y; const p=Math.min(1, Math.hypot(dx,dy)/(180*DPR)); setPower(p); }
  for(let i=state.hearts.length-1;i>=0;i--){
    const h=state.hearts[i];
    h.life -= dt; h.vy += G*dt; h.x += h.vx*dt; h.y += h.vy*dt; h.ang += h.spin*dt;
    const ground=H-90*DPR;
    if(h.y > ground){ h.y=ground; h.vy*=-0.25; h.vx*=0.7; h.bounces++; if(h.bounces>=1 || Math.abs(h.vy)<60){ state.hearts.splice(i,1); continue; } }
    if(h.life<=0 || h.x<-150 || h.x>W+150 || h.y>H+220){ state.hearts.splice(i,1); continue; }
    const dx=h.x-boss.x, dy=h.y-boss.y, R=boss.r+(120*DPR*h.scale);
    if(dx*dx+dy*dy<=R*R){ const dmg = Math.min(22, Math.max(8, Math.hypot(h.vx,h.vy)/1300*22)); boss.hp=Math.max(0,boss.hp-dmg); state.score+=Math.round(dmg); spawnBurst(h.x,h.y,h.hue,28); state.hearts.splice(i,1); if(boss.hp<=0) youWin(); }
    for(const b of state.blocks){ if(b.hp<=0) continue; if(h.x>b.x&&h.x<b.x+b.w&&h.y>b.y&&h.y<b.y+b.h){ b.hp -= 18; h.vy*=-0.5; h.vx*=0.7; spawnBurst(h.x,h.y,h.hue,18); if(b.hp<=0) state.score += 15; } }
  }
  for(let i=state.particles.length-1;i>=0;i--){ const p=state.particles[i]; p.life-=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=800*dt; if(p.life<=0) state.particles.splice(i,1); }
}

function draw(){
  ctx.clearRect(0,0,W,H);
  const g=ctx.createRadialGradient(W/2,H*0.25,10,W/2,H*0.25,Math.max(W,H)*0.8);
  g.addColorStop(0,'rgba(255,255,255,.03)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ctx.fillStyle='#0b132f'; ctx.fillRect(0, H-90*DPR, W, 90*DPR);
  if(state.aiming && aimPt){ ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=3*DPR; ctx.beginPath(); ctx.moveTo(sling.x, sling.y); ctx.lineTo(aimPt.x, aimPt.y); ctx.stroke(); }
  // Tuy·∫øt Hoa
  ctx.save(); ctx.translate(TH.x, TH.y); ctx.fillStyle='rgba(255,255,255,.98)'; ctx.beginPath(); ctx.arc(0,0,30*DPR,0,Math.PI*2); ctx.fill(); ctx.fillStyle='rgba(255,156,203,.98)'; ctx.fillRect(-24*DPR,12*DPR,48*DPR,58*DPR); ctx.fillStyle='#fff'; ctx.font=`${18*DPR}px system-ui`; ctx.textAlign='center'; ctx.fillText('Tuy·∫øt Hoa', 0, 84*DPR); ctx.restore();
  // boss
  ctx.save(); ctx.translate(boss.x,boss.y); ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.arc(8*DPR,8*DPR,boss.r+8*DPR,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#222c5a'; ctx.beginPath(); ctx.arc(0,0,boss.r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#ffd166'; ctx.font=`${20*DPR}px system-ui`; ctx.textAlign='center'; ctx.fillText('Boss: Quy',0,boss.r+30*DPR); const pct=boss.hp/100; ctx.strokeStyle='#f43f5e'; ctx.lineWidth=12*DPR; ctx.beginPath(); ctx.arc(0,0,boss.r+18*DPR,-Math.PI/2,-Math.PI/2+Math.PI*2*pct); ctx.stroke(); ctx.restore();
  // blocks
  for(const b of state.blocks){ if(b.hp<=0) continue; ctx.fillStyle='rgba(255,255,255,.12)'; ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2*DPR; ctx.fillRect(b.x,b.y,b.w,b.h); ctx.strokeRect(b.x,b.y,b.w,b.h); }
  for(const h of state.hearts){ drawHeartAt(h.x,h.y,h.scale,h.ang,h.hue); }
  for(const p of state.particles){ ctx.globalAlpha=Math.max(0,p.life/0.9); ctx.fillStyle=`hsl(${(p.h+Math.random()*30)|0},100%,60%)`; ctx.beginPath(); ctx.arc(p.x,p.y,3*DPR+Math.random()*4*DPR,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
  bossHpEl.textContent = Math.max(0,boss.hp).toFixed(0);
  scoreEl.textContent  = state.score.toFixed(0);
}

let last=0; function loop(ts){ const dt=Math.min(0.04,(ts-last)/1000 || 0); last=ts; if(!state.gameover){ update(dt); draw(); } requestAnimationFrame(loop); }
requestAnimationFrame(loop);

function youWin(){ state.gameover=true; document.getElementById('win').classList.remove('hidden'); }
function youLose(){ state.gameover=true; document.getElementById('lose').classList.remove('hidden'); }
function restart(){ state.hearts.length=0; state.particles.length=0; state.score=0; boss.hp=100; setupBlocks(); state.gameover=false; document.getElementById('win').classList.add('hidden'); document.getElementById('lose').classList.add('hidden'); }

setInterval(()=>{ if(!state.gameover && boss.hp>0){ youLose(); } }, 120000);

const fsBtn = document.getElementById('fs');
fsBtn.addEventListener('click', async ()=>{ const el=document.documentElement; try{ if(!document.fullscreenElement){ await el.requestFullscreen?.(); fsBtn.textContent='‚§°'; } else { await document.exitFullscreen?.(); fsBtn.textContent='‚§¢'; } }catch{} });
const vibBtn = document.getElementById('vib');
vibBtn.addEventListener('click', ()=>{ state.vibrate=!state.vibrate; vibBtn.style.background = state.vibrate ? 'rgba(34,197,94,.35)' : 'rgba(255,255,255,.14)'; if(state.vibrate && navigator.vibrate) navigator.vibrate(20); });

// init
resize();
</script>
</body>
</html>


