<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>thu thập trái tim của quy :))</title>
  <style>
    :root{ --bg1:#0e1224; --bg2:#060915; }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%;margin:0}
    body{
      background:radial-gradient(1200px 800px at 50% 30%,var(--bg1),var(--bg2));
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#fff;overflow:hidden;
      touch-action:manipulation;
    }
    canvas{position:fixed;inset:0;display:block}
    .title{
      position:fixed;left:50%;top:10%;transform:translate(-50%,-50%);
      font-size:clamp(18px,6vmin,44px);font-weight:900;letter-spacing:.02em;
      -webkit-text-stroke:1px rgba(255,255,255,.6);
      background:linear-gradient(90deg,#ff3d81,#ffb86b,#ffee55,#7dfc8a,#5ad2ff,#a78bfa,#ff3d81);
      background-size:200% 100%;-webkit-background-clip:text;background-clip:text;color:transparent;
      filter:drop-shadow(0 6px 14px rgba(0,0,0,.6)); animation:glint 6s linear infinite;
      pointer-events:none;
    }
    @keyframes glint{to{background-position:200% 0}}
    /* Start button only */
    .startWrap{ position:fixed; inset:0; display:grid; place-items:center; z-index:10; }
    .startBtn{
      padding:16px 22px; border-radius:16px; font-weight:900; font-size:18px; cursor:pointer;
      background:rgba(255,255,255,.1); color:#fff; border:1px solid rgba(255,255,255,.3);
      backdrop-filter:blur(6px); box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .smallHint{ margin-top:10px; font-size:12px; opacity:.8; text-align:center }
    .hidden{ display:none }
    /* Love overlay */
    .loveOverlay{ position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45);
      backdrop-filter: blur(6px); opacity:0; pointer-events:none; transition:opacity .35s ease; z-index:12; }
    .loveOverlay.show{ opacity:1; pointer-events:auto; }
    .loveBox{ text-align:center; padding:24px 28px; border-radius:20px;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); box-shadow: 0 10px 40px rgba(0,0,0,.35); animation: pop .5s ease; }
    @keyframes pop{ from{ transform:scale(.85); opacity:.3 } to{ transform:scale(1); opacity:1 } }
    .loveText{ font-size:clamp(28px,8vmin,72px); font-weight:900; letter-spacing:.04em;
      background:linear-gradient(90deg,#ff3d81,#ff8ab4,#ffd1dc); -webkit-background-clip:text; background-clip:text; color:transparent;
      -webkit-text-stroke:1px rgba(255,255,255,.6); text-shadow: 0 8px 30px rgba(255,62,113,.25); }
    .subLove{ margin-top:6px; opacity:.9 }
    .btn{margin-top:14px; padding:12px 16px; border-radius:12px; font-weight:900; cursor:pointer;
         background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); color:#fff }
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);padding:10px 14px;border-radius:12px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(8px);font-weight:800;opacity:0;transition:opacity .25s;z-index:11}
    .toast.show{opacity:1}
    @media (max-height: 720px){ .title{display:none} }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div class="title">thu thập trái tim của quy :))</div>

  <!-- Chỉ có nút bắt đầu/chơi lại -->
  <div class="startWrap" id="startWrap">
    <div style="text-align:center">
      <button class="startBtn" id="btnStart">Bắt đầu (30s)</button>
      <div class="smallHint">Chỉ cần bấm vào trái tim để lấy điểm • Mục tiêu 500</div>
    </div>
  </div>

  <!-- LOVE YOU -->
  <div class="loveOverlay" id="loveOverlay">
    <div class="loveBox">
      <div class="loveText">I LOVE YOU 💖</div>
      <div class="subLove">— gửi đến <b>Tuyết Hoa</b> —</div>
      <button class="btn" id="btnContinue">Chơi tiếp</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ====== setup ======
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha: true });
    const DPR = Math.max(1, Math.min(1.5, window.devicePixelRatio||1));
    let W=0,H=0;
    function resize(){ W=canvas.width=innerWidth*DPR; H=canvas.height=innerHeight*DPR; canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; }
    addEventListener('resize', resize, {passive:true}); resize();

    const toast = document.getElementById('toast');
    const startWrap = document.getElementById('startWrap');
    const btnStart = document.getElementById('btnStart');
    const loveOverlay = document.getElementById('loveOverlay');
    const btnContinue = document.getElementById('btnContinue');

    // ====== drawing ======
    const heartPath = new Path2D("M128 224s-64-36.8-96-80C8 88 32 48 64 48c24 0 40 16 64 40 24-24 40-40 64-40 32 0 56 40 32 96-32 43.2-96 80-96 80z");

    function drawHeart(x,y,s,hue,alpha=1){
      ctx.save(); ctx.translate(x,y); ctx.scale(s,s); ctx.globalAlpha = alpha;
      const grad = ctx.createLinearGradient(-128,0,128,0);
      const c = [(hue)%360,(hue+60)%360,(hue+120)%360,(hue+180)%360,(hue+240)%360,(hue+300)%360];
      grad.addColorStop(0, `hsl(${c[0]},100%,60%)`);
      grad.addColorStop(.2, `hsl(${c[1]},100%,60%)`);
      grad.addColorStop(.4, `hsl(${c[2]},100%,60%)`);
      grad.addColorStop(.6, `hsl(${c[3]},100%,60%)`);
      grad.addColorStop(.8, `hsl(${c[4]},100%,60%)`);
      grad.addColorStop(1, `hsl(${c[5]},100%,60%)`);
      ctx.fillStyle = grad; ctx.strokeStyle = 'rgba(255,255,255,.95)'; ctx.lineWidth = 6/DPR;
      ctx.filter = 'drop-shadow(0 6px 14px rgba(0,0,0,.35))';
      ctx.fill(heartPath); ctx.stroke(heartPath);
      // chữ "quy" giữa
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font = `900 ${84}px system-ui,Segoe UI,Arial`;
      ctx.lineWidth = 12; ctx.strokeStyle = 'rgba(255,255,255,.95)';
      ctx.strokeText('quy', 128, 128);
      ctx.fillStyle = 'rgba(10,10,30,.92)';
      ctx.fillText('quy', 128, 128);
      ctx.restore();
    }

    // ====== game ======
    const entities = [];
    let score=0, combo=1, timeLeft=30, t0=0, paused=true, over=false, emitTimer=0, hueBase=0;
    const GOAL = 500;

    function diff(){ return {rate: 0.55, speed: [80,150], size:[0.36,0.52], time: 30}; }
    let conf = diff();

    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.classList.remove('show'), 900); }

    function spawnHeart(){
      const side = Math.random() < 0.5 ? -1 : 1;
      const x = (W/2) + side*(W*0.33)*Math.random();
      const y = -160*DPR;
      const sp = conf.speed[0] + Math.random()*(conf.speed[1]-conf.speed[0]);
      const size = conf.size[0] + Math.random()*(conf.size[1]-conf.size[0]);
      const hue = (hueBase + Math.random()*60) % 360;
      const rotRate = (Math.random()*2-1)*0.35;
      entities.push({x,y,vy:sp,scale:size*DPR,alive:true,hue,a:1,rot:0,rotRate});
    }

    function tick(dt){
      emitTimer -= dt;
      if (emitTimer <= 0){ spawnHeart(); emitTimer = conf.rate; }
      hueBase = (hueBase + 20*dt)%360;
      for (let i=entities.length-1;i>=0;i--){
        const e = entities[i];
        e.y += e.vy*dt;
        e.rot += e.rotRate*dt;
        if (e.y - 150*e.scale > H) entities.splice(i,1);
      }
    }

    function render(){
      ctx.clearRect(0,0,W,H);
      const g = ctx.createRadialGradient(W/2,H*0.3,10,W/2,H*0.3,Math.max(W,H)*0.8);
      g.addColorStop(0,'rgba(255,255,255,.03)'); g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
      entities.forEach(e=>{ ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(e.rot); drawHeart(0,0,e.scale,e.hue,e.a); ctx.restore(); });
      renderParticles(0.016);
    }

    function loop(ts){
      if (!t0) t0 = ts;
      const dt = Math.min(0.05, (ts - t0)/1000);
      t0 = ts;
      if (!paused && !over){
        timeLeft -= dt;
        if (timeLeft <= 0){ endGame(); return; }
        tick(dt);
        render();
      } else {
        render();
      }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    function pointHitHeart(px, py){
      for (let i=entities.length-1;i>=0;i--){
        const h = entities[i];
        const inv = new DOMMatrix().translate(h.x,h.y).rotate(h.rot*180/Math.PI).scale(h.scale,h.scale).invertSelf();
        const pt = new DOMPoint(px,py).matrixTransform(inv);
        if (ctx.isPointInPath(heartPath, pt.x, pt.y)){ return i; }
      }
      return -1;
    }

    function popAt(x,y){
      const idx = pointHitHeart(x,y);
      if (idx>=0){
        const h = entities[idx];
        makeParticles(h.x, h.y, h.hue);
        entities.splice(idx,1);
        score += Math.ceil(10*combo);
        combo = Math.min(10, combo+0.25);
        soundPop();
        if (score >= GOAL && !loveOverlay.classList.contains('show')){
          showLove();
        } else {
          showToast('+ ' + Math.ceil(10*combo) + '  •  ' + score + '/' + GOAL);
        }
      } else {
        combo = 1; soundMiss();
      }
    }

    canvas.addEventListener('pointerdown', e=>{
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * DPR;
      const y = (e.clientY - rect.top) * DPR;
      popAt(x,y);
    }, {passive:true});

    // particles
    const particles=[];
    function makeParticles(x,y,hue){
      for (let i=0;i<30;i++){
        const a = Math.random()*Math.PI*2;
        const sp = 60 + Math.random()*220;
        particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:0.7,size:3+Math.random()*6,hue});
      }
    }
    function renderParticles(dt){
      for (let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.life -= dt;
        p.x += p.vx*dt; p.y += p.vy*dt;
        if (p.life<=0){ particles.splice(i,1); continue; }
        ctx.save();
        ctx.globalAlpha = Math.max(0,p.life/0.7);
        ctx.fillStyle = `hsl(${(p.hue+Math.random()*40)%360},100%,60%)`;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
        ctx.restore();
      }
    }

    // flow
    function startGame(){
      conf = diff();
      score=0; combo=1; over=false; paused=false; entities.length=0; particles.length=0;
      timeLeft = conf.time; emitTimer = 0; hueBase=0;
      startWrap.classList.add('hidden');
      showToast('Bắt đầu!');
    }
    function endGame(){
      over = true; paused = true;
      startWrap.classList.remove('hidden');
      btnStart.textContent = 'Chơi lại (30s) • Điểm: ' + score;
      showToast('Hết giờ! Điểm: ' + score);
    }
    function showLove(){ paused = true; loveOverlay.classList.add('show'); }
    btnContinue.addEventListener('click', ()=>{ loveOverlay.classList.remove('show'); paused = false; });

    btnStart.addEventListener('click', startGame);

    // simple sounds
    let actx, master;
    function ensureAudio(){ if (!actx){ actx = new (window.AudioContext||window.webkitAudioContext)(); master = actx.createGain(); master.connect(actx.destination); master.gain.value=.25; } }
    function soundPop(){ ensureAudio(); const o=actx.createOscillator(), g=actx.createGain(); o.type='sine'; o.frequency.value=520; o.connect(g); g.connect(master); const t=actx.currentTime; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(.6,t+.01); o.frequency.exponentialRampToValueAtTime(880,t+.07); g.gain.exponentialRampToValueAtTime(0.0001,t+.12); o.start(t); o.stop(t+.15); }
    function soundMiss(){ ensureAudio(); const o=actx.createOscillator(), g=actx.createGain(); o.type='sawtooth'; o.frequency.value=220; o.connect(g); g.connect(master); const t=actx.currentTime; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(.5,t+.01); o.frequency.exponentialRampToValueAtTime(140,t+.2); g.gain.exponentialRampToValueAtTime(0.0001,t+.25); o.start(t); o.stop(t+.3); }

    // unlock audio on first tap
    document.addEventListener('pointerdown', ()=>{ if(!actx){ ensureAudio(); } }, {once:true});
  </script>
</body>
</html>

